machine:
  environment:
    LEAGUE_TOKEN: dummy-token

dependencies:
  override:
    - pip install -r requirements.txt
    - pip install -r requirements-dev.txt
    - pip install coveralls
    - python setup.py install

test:
  override:
    - python setup.py test
    - tox
  post:
    - mv htmlcov $CIRCLE_ARTIFACTS/coverage
    - mv .junitxml $CIRCLE_TEST_REPORTS/junit.xml
    - coveralls
    - git fetch --tags

deployment:
  release:
    tag: /[0-9]+\.[0-9]+\.[0-9]+/
    commands:
      - rm -f ~/.pypirc
      - echo "[server-login]" > ~/.pypirc
      - echo "username:$PYPI_USERNAME" >> ~/.pypirc
      - echo "password:$PYPI_PASSWORD" >> ~/.pypirc

      - .tox/py34/bin/python setup.py register

      - .tox/py34/bin/python setup.py sdist upload

      - .tox/py27/bin/python setup.py bdist_egg upload
      - .tox/py34/bin/python setup.py bdist_egg upload

      - .tox/py34/bin/python setup.py bdist_wheel upload

      - rm -f ~/.pypirc
