machine:
  environment:
    CHAMPIONGG_TOKEN: dummy-token
    LEAGUE_TOKEN: dummy-token

dependencies:
  pre:
    - pyenv install --list

    - test -e /opt/circleci/.pyenv/versions/3.5-dev || pyenv install 3.5-dev
    - test -e /opt/circleci/.pyenv/versions/3.6-dev || pyenv install 3.6-dev
    - test -e /opt/circleci/.pyenv/versions/3.7-dev || pyenv install 3.7-dev
    - pyenv local 3.5.2 3.5-dev 3.6.0 3.6-dev 3.7-dev

  override:
    - pip install pre-commit tox tox-pyenv
    - tox --notest

  cache_directories:
    - "/opt/circleci/.pyenv"
    - ".tox"

test:
  override:
    - pre-commit run --all-files
    - tox

  post:
    - mv htmlcov $CIRCLE_ARTIFACTS/coverage
    - mv .junitxml $CIRCLE_TEST_REPORTS/junit.xml
    - git fetch --tags

deployment:
  release:
    tag: /[0-9]+\.[0-9]+\.[0-9]+/
    commands:
      - curl -L https://github.com/aktau/github-release/releases/download/v0.6.2/linux-amd64-github-release.tar.bz2 > github-release.tar.bz2
      - tar xjf github-release.tar.bz2
      - rm -f github-release.tar.bz2

      - echo "[server-login]" > ~/.pypirc
      - echo "username:$PYPI_USERNAME" >> ~/.pypirc
      - echo "password:$PYPI_PASSWORD" >> ~/.pypirc

      - .tox/py35/bin/python setup.py register

      - .tox/py35/bin/python setup.py sdist upload

      - .tox/py35/bin/python setup.py bdist_egg upload
      - .tox/py36/bin/python setup.py bdist_egg upload

      - .tox/py35/bin/python setup.py bdist_wheel upload

      - rm -f ~/.pypirc

      - ./bin/linux/amd64/github-release release --user TheKevJames --repo league --tag $(git tag --sort=version:refname | tail -n1) --name "LeagueUtils" --description "$(git log $(git tag --sort=version:refname | tail -n2 | head -n1)..$(git tag --sort=version:refname | tail -n1)~1 --pretty=format:'- %s')" || ./bin/linux/amd64/github-release edit --user TheKevJames --repo league --tag $(git tag --sort=version:refname | tail -n1) --name "LeagueUtils" --description "$(git log $(git tag --sort=version:refname | tail -n2 | head -n1)..$(git tag --sort=version:refname | tail -n1)~1 --pretty=format:'- %s')"

      - .tox/py35/bin/pyinstaller --onefile league-utils.py
      - ./bin/linux/amd64/github-release upload --user TheKevJames --repo league --tag $(git tag --sort=version:refname | tail -n1) --name "league-utils-linux-amd64" --file dist/league-utils
